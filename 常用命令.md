##### det

构建

```bash
sudo docker build \
    -t harbor.tianrang.com/traffic/object_detection:0.4_service_stress \
    -f docker/Dockerfile ./
```

推送

```bash
docker push harbor.tianrang.com/traffic/objection:0.4_service800
```

本机

```bash
docker run -itd \
           -v /home/tesla/demot/det/object_detection:/object_detection \
           -v /home/tesla/demot/det/data:/object_detection/data \
           -v /home/tesla/demot/det/config:/object_detection/config \
           -v /home/tesla/demot/det/video:/object_detection/video \
           -v /home/tesla/demot/det/logs:/object_detection/logs \
           -v /home/tesla/demot/det/picture:/object_detection/picture \
           -v /home/tesla/demot/det/model:/object_detection/model \
           -e CONFIG_PATH=/object_detection/config/config \
           -e SERVICE_NAME=object-detection-1 \
           --name det \
           --runtime=nvidia \
           --net=host \
           harbor.tianrang.com/traffic/cuda10.1_opencv:0.0.4 \
           /bin/bash
```

12服务器

```bash
sudo docker run -itd \
                -v /disk4/xbzhang/demot/object_detection:/object_detection \
                -v /disk4/xbzhang/demot/vidtest/video:/object_detection/video \
                -v /disk4/xbzhang/demot/vidtest/config:/object_detection/config \
                -v /disk4/xbzhang/demot/vidtest/det/data:/object_detection/data \
                -v /disk4/xbzhang/demot/vidtest/det/logs:/object_detection/logs \
                -v /disk4/xbzhang/demot/vidtest/det/picture:/object_detection/picture \
                -e CONFIG_PATH=/object_detection/config/config \
                -e SERVICE_NAME=object-detection-2 \
                --name det \
                harbor.tianrang.com/traffic/cuda10.1_opencv:0.0.4 \
                /bin/bash
```

30服务器

```bash
sudo docker run -itd \
                -v /disk5/xbzhang/demot/object_detection:/object_detection \
                -v /disk5/xbzhang/demot/vidtest/video:/object_detection/video \
                -v /disk5/xbzhang/demot/vidtest/config:/object_detection/config \
                -v /disk5/xbzhang/demot/vidtest/det/data:/object_detection/data \
                -v /disk5/xbzhang/demot/vidtest/det/logs:/object_detection/logs \
                -v /disk5/xbzhang/demot/vidtest/det/picture:/object_detection/picture \
                -e CONFIG_PATH=/object_detection/config/config \
                -e SERVICE_NAME=object-detection-2 \
                --name det \
                harbor.tianrang.com/traffic/cuda10.1_opencv:0.0.4 \
                /bin/bash
```

14服务器docker 

```bash
nvidia-docker run -itd \
           -v /disk5/changchun/object_detection/video:/object_detection/video \
           -v /disk5/changchun/object_detection/config:/object_detection/config \
           -v /disk5/changchun/object_detection/data:/object_detection/data \
           -v /disk5/changchun/object_detection/logs:/object_detection/logs \
           -v /disk5/changchun/object_detection/picture:/object_detection/picture \
           -e CONFIG_PATH=/object_detection/config/config \
           -e SERVICE_NAME=object-detection-1 \
           --name det \
           harbor.tianrang.com/traffic/object_detection:0.4_service \
           /bin/bash
```

14服务器docker 800

```bash
nvidia-docker run -itd \
           -v /disk5/changchun/object_detection_800/video:/object_detection/video \
           -v /disk5/changchun/object_detection_800/config:/object_detection/config \
           -v /disk5/changchun/object_detection_800/data:/object_detection/data \
           -v /disk5/changchun/object_detection_800/logs:/object_detection/logs \
           -v /disk5/changchun/object_detection_800/picture:/object_detection/picture \
           -e CONFIG_PATH=/object_detection/config/config \
           -e SERVICE_NAME=object-detection-1 \
           --name det800 \
           harbor.tianrang.com/traffic/objection:0.4_service800 \
           /bin/bash
```

14服务器det stress

```bash
nvidia-docker run -itd \
           -v /disk5/changchun/object_detection_stress/video:/object_detection/video \
           -v /disk5/changchun/object_detection_stress/config:/object_detection/config \
           -v /disk5/changchun/object_detection_stress/data:/object_detection/data \
           -v /disk5/changchun/object_detection_stress/logs:/object_detection/logs \
           -v /disk5/changchun/object_detection_stress/picture:/object_detection/picture \
           -e CONFIG_PATH=/object_detection/config/config \
           -e SERVICE_NAME=object-detection-1 \
           --name detstr \
           harbor.tianrang.com/traffic/object_detection:0.4_service_stress1 \
           /bin/bash
```

##### mot

本机

```bash
docker run -itd \
           -v /home/tesla/Workspace/demot/MOT:/MOT \
           -v /home/tesla/Workspace/demot/vidtest/config:/MOT/config \
           -v /home/tesla/Workspace/demot/vidtest/mot/logs:/MOT/logs \
           -v /home/tesla/Workspace/demot/vidtest/mot/data:/MOT/data \
           -e CONFIG_PATH=/MOT/config/config \
           -e SERVICE_NAME=mot-1 \
           --name mot \
           --net=host \
           harbor.tianrang.com/traffic/deep_sort:0.0.1 \
           /bin/bash
```

12服务器

```bash
sudo docker run -itd \
                -v /disk4/xbzhang/demot/MOT:/MOT \
                -v /disk4/xbzhang/demot/vidtest/config:/MOT/config \
                -v /disk4/xbzhang/demot/vidtest/mot/logs:/MOT/logs \
                -v /disk4/xbzhang/demot/vidtest/mot/data:/MOT/data \
                -e CONFIG_PATH=/MOT/config/config \
                -e SERVICE_NAME=mot-2 \
                --name mot \
                harbor.tianrang.com/traffic/deep_sort:0.0.1 \
                /bin/bash
```

30服务器

```bash
sudo docker run -itd \
                -v /disk5/xbzhang/demot/MOT:/MOT \
                -v /disk5/xbzhang/demot/vidtest/config:/MOT/config \
                -v /disk5/xbzhang/demot/vidtest/mot/logs:/MOT/logs \
                -v /disk5/xbzhang/demot/vidtest/mot/data:/MOT/data \
                -e CONFIG_PATH=/MOT/config/config \
                -e SERVICE_NAME=mot-2 \
                --name mot \
                harbor.tianrang.com/traffic/deep_sort:0.0.1 \
                /bin/bash
```

##### redis

本机

```bash
docker run -itd \
           -p 20303:6379 \
           -v /home/tesla/Applications/redis/data:/data \
           --name redis \
           redis:5.0 \
           redis-server \
           --appendonly yes
```

30服务器

```bash
sudo docker run -itd \
                -p 20303:6379 \
                -v /disk5/xbzhang/demot/redis/redis.conf:/etc/redis/redis.conf \
                -v /disk5/xbzhang/demot/redis/data:/data \
                --name redis \
                redis:5.0 \
                redis-server /etc/redis/redis.conf \
                --appendonly yes
```

12服务器

````bash
sudo docker run -itd \
                -p 20303:6379 \
                -v /disk4/xbzhang/demot/redis/redis.conf:/etc/redis/redis.conf \
                -v /disk4/xbzhang/demot/redis/data:/data \
                --name redis-zxb \
                redis:5.0 \
                redis-server /etc/redis/redis.conf \
                --appendonly yes
````

14服务器

```
sudo docker run -itd \
                -p 20303:6379 \
                -v /disk5/changchun/redis/redis.conf:/etc/redis/redis.conf \
                -v /disk5/changchun/redis/data:/data \
                --name redis \
                redis:5.0 \
                redis-server /etc/redis/redis.conf \
                --appendonly yes
```



##### ffmpeg

视频转换为图片

```bash
ffmpeg -i target.mp4 -r 1 -f image2 imgdir/%d.jpg
```

图片转换为视频

```bash
ffmpeg -f image2 -i imgdir/%d.jpg rst.mp4
```

##### pytorch

训练

```bash
python -m torch.distributed.launch --nproc_per_node 6 train.py --device 2,3,4,5,6,7 --cfg weights/psvhc_416_ms_prunex2_50e_201129/prune_0.3_keep_0.01_2_shortcut_prune_0.7_keep_0.01_8_shortcut_yolov3-psvhc.cfg --data data/psvhc.data --weights weights/psvhc_416_ms_prunex2_50e_201129/prune_0.3_keep_0.01_2_shortcut_best.weights --epoch 50 --adam --img-size 416 --batch-size 48 --accumulate 1 --output weights/psvhc_416_ms_prunex3_50e_201130 --multi-scale -sr --s 0.0002 --prune 1
```

pytorch2darknet

```bash
python -c "from models import *; convert('cfg/yolov3-psvhc-prunex2-201103.cfg', 'model/yolov3-psvhc-prunex2-201103.pt')"
```

##### det镜像构建

运行基础镜像

```bash
docker run -itd \
           -v /home/tesla/demot/object_detection:/det \
           -v /home/tesla/demot/vidtest/det/data:/det/data \
           -v /home/tesla/demot/vidtest/det/config:/det/config \
           -v /home/tesla/demot/vidtest/det/video:/det/video \
           -v /home/tesla/demot/vidtest/det/logs:/det/logs \
           -v /home/tesla/demot/vidtest/det/picture:/det/picture \
           -e CONFIG_PATH=/det/config/config \
           -e SERVICE_NAME=object-detection-1 \
           --name det \
           --runtime=nvidia \
           harbor.tianrang.com/traffic/cuda10.1_opencv:0.0.4 \
           /bin/bash
```

##### yolov3镜像运行

本机

```bash
docker run -itd \
           -v /home/tesla/demot/yolov3:/yolov3 \
           --name yolov3 \
           --runtime=nvidia \
           harbor.tianrang.com/traffic/yolov3_dev:1.0 \
           /bin/bash
```

##### ubuntu

```bash
docker run -itd \
           --name ubuntu \
           --runtime=nvidia \
           --privileged=true \
           ubuntu:18.04 \
           /bin/bash
```

